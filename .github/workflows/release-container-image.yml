name: release-container-image

on:
  workflow_dispatch:
    inputs:
      optic_version:
        required: true
        type: string
        description: >
          The Optic version to package in the image. Any NPM dist tag or published semver version is technically
          supported, but this value is also used as the image tag, so avoid using 'latest'.
  workflow_call:
    inputs:
      optic_version:
        required: true
        type: string
        description: >
          The Optic version to package in the image. Any NPM dist tag or published semver version is technically
          supported, but this value is also used as the image tag, so avoid using 'latest'.

env:
  SKIP_ANNOUNCE: 'false'
  SKIP_PUBLISH: 'false'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Task
        run: curl -sL https://taskfile.dev/install.sh | sudo bash -s -- -b /usr/local/bin/

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and publish
        run: task docker:build:release OPTIC_CLI_VERSION="${{ inputs.optic_version }}" -- --push

      - name: Announce success
        uses: Ilshidur/action-slack@689ad44a9c9092315abd286d0e3a9a74d31ab78a # v2.1.0
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.BUILD_BOT_SLACK_WEBHOOK_URL_RELEASES }}
        with:
          args: '{{ GITHUB_ACTOR }}: âœ… useoptic/optic:{{ VERSION }} published to Docker Hub!'

      - name: Announce failure
        uses: Ilshidur/action-slack@689ad44a9c9092315abd286d0e3a9a74d31ab78a # v2.1.0
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.BUILD_BOT_SLACK_WEBHOOK_URL_RELEASES }}
        with:
          args: '{{ GITHUB_ACTOR }}: ðŸš« useoptic/optic:{{ VERSION }} failed to publish to Docker Hub.'
